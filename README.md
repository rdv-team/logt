# RDV-LogT: анализ длительных операций по технологическому журналу 1С (загрузка в ClickHouse)

> LogT – парсер технологического журнала 1С (ТЖ) с восстановлением хронологии операций и выгрузкой в ClickHouse: читает технологический журнал, собирает все события в отдельные пользовательские операции, отбирает проблемные по длительности и сохраняет их в ClickHouse для быстрого поиска узких мест и причин медленной работы через интерфейс обработки 1С.

[![Python](https://img.shields.io/badge/Python-3.13%2B-blue.svg)]()
[![ClickHouse](https://img.shields.io/badge/ClickHouse-supported-brightgreen.svg)]()
[![Status](https://img.shields.io/badge/status-active-success.svg)]()
[![OpenYellow](https://openyellow.openintegrations.dev/data/badges/1066930411.svg)](https://openyellow.org/grid?filter=top&repo=1066930411)

## Краткое описание
- **Проблема:** документ проводится 2 минуты, замер производительности через конфигуратор на рабочей базе невозможен или проблема плавающая, в ТЖ слишком много различных событий, но требуется отсеять только события операции проведения конкретного документа, конкретного пользователя в конкретное время.
- **Решение:** LogT – **парсер технологического журнала 1С**, который потоково читает `.log` и **собирает события в одну операцию**: `VRSREQUEST → VRSRESPONSE` и `SESN Start → Finish`. 
- **Выход:** операции, события и статистика сохраняются в **ClickHouse** (`operations`, `events`, `event_stats`, `calls`).
- **Интерфейс:** анализ выполняется в обработке 1С **«Трассировка длительных операций»** (расширение из `releases_1c`).

---

## Содержание
- [RDV-LogT: анализ длительных операций по технологическому журналу 1С (загрузка в ClickHouse)](#rdv-logt-анализ-длительных-операций-по-технологическому-журналу-1с-загрузка-в-clickhouse)
  - [Краткое описание](#краткое-описание)
  - [Содержание](#содержание)
  - [Назначение](#назначение)
  - [Архитектура](#архитектура)
  - [Установка](#установка)
  - [Конфигурация технологического журнала](#конфигурация-технологического-журнала)
  - [Быстрый старт](#быстрый-старт)
    - [Установка ClickHouse в Windows 11 через Docker Desktop](#установка-clickhouse-в-windows-11-через-docker-desktop)
    - [Если есть сервер под управлением Linux с установленным clickhouse](#если-есть-сервер-под-управлением-linux-с-установленным-clickhouse)
    - [Запуск обработки трассировки из расширения 1С](#запуск-обработки-трассировки-из-расширения-1с)
  - [Руководство пользователя](#руководство-пользователя)
  - [Конфигурация `config.json`](#конфигурация-configjson)
  - [Схема таблиц ClickHouse](#схема-таблиц-clickhouse)
  - [Минимальные системные требования для сервера ClickHouse](#минимальные-системные-требования-для-сервера-clickhouse)
  - [Логирование](#логирование)
  - [Ограничения](#ограничения)
  - [Как можно помочь проекту](#как-можно-помочь-проекту)
    - [Сообщить об ошибке или предложить идею](#сообщить-об-ошибке-или-предложить-идею)
    - [Почему мы не принимаем pull request'ы?](#почему-мы-не-принимаем-pull-requestы)
  - [Лицензия](#лицензия)

---

## Назначение

Инструмент предназначен для анализа **длительных операций в системах 1С** на основе технологического журнала (ТЖ).

Применяется в ситуациях, когда необходимо:
- найти конкретные пользовательские операции или фоновые задания, которые выполняются долго;
- восстановить полную хронологию событий пользовательского действия от запроса клиента до ответа сервера или от старта и завершения фонового задания;
- понять, на что реально тратится время внутри операции: БД, блокировки, вызовы кода, ожидания, исключения и т.д.;
- стандартный анализ ТЖ показывает слишком много событий и невозможно связать их в одну операцию.

Инструмент потоково читает технологический журнал, **восстанавливает границы операций (VRSREQUEST → VRSRESPONSE)** и **SESN Start → Finish**, отбирает проблемные по длительности и загружает данные в ClickHouse для детального анализа причин замедлений.

---

## Архитектура

```
├── main.py                     # Точка входа: загрузка конфигурации, парсин техжурнала, вставка в ClickHouse
├── config.json                 # Конфигурация подключения и параметров обработки
├── create_table_clickhouse.sql # SQL-схемы для ClickHouse
├── requirements.txt            # Зависимости Python
```

Ключевые моменты:
- Построчное чтение файлов `.log` из каталогов рабочих процессов `rphost_*` и `rmngr_*` (`utf-8`, `utf-8-sig`).
- Для клиент-серверных вызовов события собираются в одну операцию по `clientID`. Начало операции определяется событием `VRSREQUEST`, конец — событием `VRSRESPONSE`. 
- Для фоновых заданий события собираются в одну операцию по `SessionID`. Начало операции определяется событием `SESN, Func=Start`, конец — событием `SESN, Func=Finish`. 
- Выполняется подсчёт статистики событий операции (сумма длительности, количество, % от общей длительности операции).
- Все операции и события загружаются (`JSONEachRow`) в ClickHouse.
- Анализ операций и событий внутри них выполняется обработкой **«Трассировка длительных операций»** на базе 1С.

---

## Установка

Для работы инструмента необходимо обеспечить наличие следующего ПО:

- **Python 3.13+**
- **ОС**: Windows / Linux
- **ClickHouse 25.6+**

Установка зависимостей:
```bash
pip install -r requirements.txt
```

`requirements.txt`:
```txt
requests
tqdm
```

---

## Конфигурация технологического журнала

Перед трассировкой длительных операций необходимо включить полный или ограниченный технологический журнал. Но обязательно требуется собирать события `SESN`, `VRSREQUEST` и `VRSRESPONSE`.
Примеры конфигураций технологического журнала [logcfg-full.xml](docs/example/logcfg-full.xml) или [logcfg-filter.xml](docs/example/logcfg-filter.xml)

---

## Быстрый старт

### Установка ClickHouse в Windows 11 через Docker Desktop

**Установить Docker Desktop**

1. Скачать: https://www.docker.com/products/docker-desktop
2. Установить Docker Desktop.
3. При запуске убедиться, что включено: `Use WSL 2 based engine`
4. Проверить установку:

```powershell
docker version
```

---

**Создать volume для хранения данных**

```powershell
docker volume create clickhouse_data
```

---

**Запустить ClickHouse**

```powershell
docker run -d \
  --name clickhouse-server \
  -p 8123:8123 \
  -p 9000:9000 \
  -p 9009:9009 \
  -e CLICKHOUSE_PASSWORD=StrongP@ssw0rd \
  -v clickhouse_data:/var/lib/clickhouse \
  clickhouse/clickhouse-server
```

После запуска контейнер будет виден в **Docker Desktop → Containers**.

---

**Проверка работы ClickHouse**

Открой в браузере:

```
http://localhost:8123/play
```

Это встроенный web-интерфейс ClickHouse (Query Console).  
Если он загружается - сервер работает корректно.

---

**Создание БД и таблиц из файла `create_table_clickhouse.sql`**

1. Открой файл `create_table_clickhouse.sql` в редакторе.
2. В файле содержатся SQL-команды `CREATE DATABASE` и `CREATE TABLE`.
3. Скопируй первую команду и вставь её в окно запроса на странице:

```
http://localhost:8123/play
```

4. Нажми **Run**.
5. Повтори для всех последующих команд из файла, выполняя их по одной.

После выполнения всех DDL-команд структура базы данных будет создана и готова к работе.

### Если есть сервер под управлением Linux с установленным clickhouse

1. Загрузите файл [create_table_clickhouse.sql](src/create_table_clickhouse.sql) на сервер ClickHouse.

   Подготовьте таблицы в ClickHouse:
   ```bash
   clickhouse-client --multiquery < create_table_clickhouse.sql
   ```
   С указанием пароля default пользователя:
   ```bash
   clickhouse-client --password --multiquery < create_table_clickhouse.sql
   # Пароль будет запрошен интерактивно
   ```
   
   Будет создана база данных **tracelog** с необходимыми таблицами.

### Запуск обработки трассировки из расширения 1С

1. Скачайте последнюю версию расширения из [каталога releases_1c](releases_1c). Оно содержит все необходимые объекты конфигурации для анализа результатов трассировки технологического журнала. 

2. Подключите расширение в любую базу 1С. Версия платформы 1С:Предприятие от 8.3.21.

3. Настройте подключение к базе данных ClickHouse в расширении.

4. Откройте обработку **«Трассировка длительных операций»**. 

5. Укажите базу данных и набор данных. Перейдите на страницу **Операции**. Запустите обработку файлов технологического журнала и загрузку в ClickHouse командой **Обработать данные ТЖ**. Укажите пути к файлам технологического журнала и каталогу хранения логов обработки. Конфигурационный файл `config.json` будет создан автоматически и запущен скрипт Python.

6. После загрузки в ClickHouse вернитесь в обработку **«Трассировка длительных операций»** на страницу **Операции** и нажмите «Загрузить».

## Руководство пользователя
Подробное руководство: [Анализ технологического журнала через обработку «Трассировка длительных операций»](docs/user_guide.md)

---

## Конфигурация `config.json`

| Блок | Ключ | Назначение |
|-----|------|------------|
| `clickhouse` | `url` | HTTP-адрес ClickHouse (например, `http://127.0.0.1:8123`) |
| | `user` | Пользователь ClickHouse |
| | `password` | Пароль пользователя ClickHouse |
| | `database` | Имя базы данных ClickHouse |
| `processing` | `mode` | Режим обработки логов: `single` – чтение файлов напрямую, `multi` – предварительная сборка почасовой хронологии |
| | `batch_size` | Размер батча при вставке в ClickHouse. По умолчанию – 1000 событий |
| | `timeout` | Таймаут HTTP-запросов к ClickHouse (секунды). По умолчанию – 30 |
| | `dataset_name` | Метка набора данных (используется для логического разделения данных в ClickHouse) |
| | `cleanup_temp_dir` | Удалять ли временный каталог после обработки в режиме `multi` (`true` / `false`) |
| | `client_server_operations` | Обрабатывать клиент-серверные операции (`VRSREQUEST` / `VRSRESPONSE`). По умолчанию – `true` |
| | `background_jobs` | Обрабатывать фоновые задания (`rmngr_*`, события `SESN`). По умолчанию – `true` |
| `filtering` | `min_operation_duration_ms` | Минимальная длительность операции (мс). По умолчанию – 1000 (1 секунда) |
| | `min_operation_events` | Минимальное количество событий в операции. По умолчанию – 3 |
| `paths` | `input_dir` | Каталог с файлами технологического журнала 1С |
| | `log_dir` | Каталог для логов выполнения Python-скрипта |

---

## Схема таблиц ClickHouse

См. файл [create_table_clickhouse.sql](src/create_table_clickhouse.sql).  
Три таблицы:
- **operations** — список операций (`session_id`, `client_id`, `vrs_session`, время, длительность, context).
- **events** — все события в операции.
- **event_stats** — статистика по событиям (сумма длительностей, количество, %).

---

## Минимальные системные требования для сервера ClickHouse

- **CPU**: Intel Core i5 или AMD Ryzen 5 и последующие модели
- **RAM**: 8 ГБ и выше
- **Диск**: SSD от 20 ГБ
- **ОС**: Linux x86_64

---

## Логирование

- Все логи пишутся в каталог `log_dir` из `config.json`.
- Формат: `trace-vrs-YYYYMMDD_HHMMSS.log`.
- Также выводятся в консоль.

---

## Ограничения

- Перед каждой загрузкой выбранный набор данных (`dataset`) очищается автоматически.
- Файлы логов должны соответствовать структуре ТЖ 1С (`rphost_*/*.log` или `rmngr_*/*.log`).
- Работает только с кодировками `utf-8` и `utf-8-sig`.
- Фильтрация операций выполняется по длительности и количеству событий (см. параметры в `config.json`).

---

## Как можно помочь проекту

Спасибо, что заглянули в репозиторий!  
Мы очень ценим внимание к проекту и рады любой поддержке.

Пулл-реквесты в данный репозиторий **не принимаются** — код развивается внутренней командой RDV.  
Но вы всё равно можете внести вклад:

### Сообщить об ошибке или предложить идею
Если вы заметили проблему или хотите предложить улучшение:

1. Откройте раздел **Issues**.
2. Опишите ситуацию простыми словами:  
   – что произошло,  
   – что ожидали,  
   – как можно воспроизвести проблему (если нужно).  
3. Можете приложить скриншоты, логи или примеры — это очень помогает.

Мы просматриваем все обращения и обязательно реагируем.

### Почему мы не принимаем pull request'ы?
У проекта есть своя архитектура и внутренние процессы разработки.  
Чтобы поддерживать стабильность и качество, изменения вносят только разработчики RDV.  
Но мы внимательно следим за вашими Issue — они помогают нам делать инструмент лучше.

Спасибо, что помогаете развивать проект.

---

## Лицензия

Проект распространяется под лицензией **BSD 3-Clause**.  
Подробности см. в файле [LICENSE](LICENSE).

---
